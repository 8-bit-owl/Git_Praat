function Y = middleEarConversion(X,fX)
% This function applies a middle ear transfer function to power spectrum X with bin frequencies fX.
% Input:
%    X -- Nx1 real vector, power units, power spectrum
%    fX -- Nx1 real vector, Hz, frequencies of power spectrum
% Output:
%    Y -- Nx1 real vector, power units, scaled power spectrum
%
% Reference:
% [1] Chen, Z., G. Hu, B. R. Glasberg, and B. C. J. Moore, "A new method of calculating auditory
% excitation patterns and loudness for steady sounds," Hearing Research, vol. 282, pp. 204-215, 2011

% Mark Skowronski, February 22, 2013

% Get reference parameters:
[X0,f0] = getReference();

% Linear interpolate middle ear power spectrum at fX, note: log frequency scale:
logfX = log10(fX);
logfX(fX==0) = 1; % dummy value, gain replaced with 0 below
HdB = interp1(log10(f0),X0,logfX,'linear','extrap'); % dB
H = 10.^(HdB/10); % power units

% Account for zeros in fX:
H(fX==0) = 0;

% Scale power spectrum in X by middle ear:
Y = H.*X;

return;


function [X0,f0] = getReference()
% This function specifies the transfer function of the middle ear, from Chen et al. [1], Fig. 2.
% Output:
%    X0 -- Mx1 vector, dB, gain at M frequencies
%    f0 -- Mx1 vector, Hz, frequency of gain transfer function

temp = [...
20.15811878	-32.8; ...
24.38428356	-28.7; ...
30.93392299	-23.7; ...
39.24280117	-19.8; ...
50.98207412	-16.1; ...
66.23308743	-12.6; ...
88.11807477	-9.2; ...
117.2343824	-6.7; ...
163.5723903	-4.8; ...
233.7208731	-3; ...
333.9527315	-2.3; ...
465.9507338	-1.9; ...
634.8373937	-2; ...
749.8769426	-2.6;...
907.089208	-2.5;...
1123.679609	-3.1;...
1359.259885	-4.5;...
1605.572792	-6.4;...
1765.87517	-8.5;...
1942.182336	-10.7;...
2036.831018	-11.9;...
2240.190752	-13; ...
2523.175738	-14.3;...
2841.907905	-12.7;...
3052.161431	-11.1;...
3605.2468	-10.7;...
3965.19911	-10.4;...
4466.090302	-10.5;...
5030.254984	-10.8;...
5802.097199	-12.5;...
6692.370867	-14.4;...
7537.763375	-15.7;...
8095.431457	-16.3;...
8903.68937	-15.8;...
10028.41967	-15; ...
11029.66952	-16.6;...
12722.06177	-18.7;...
13663.281	-20; ...
14674.13466	-21.8;...
17333.24996	-22.9;...
19992.86346	-23.9];

f0 = temp(:,1);
X0 = temp(:,2);

return;

